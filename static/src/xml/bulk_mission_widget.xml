<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">

    <t t-name="transport_management.BulkMissionWidget" owl="1">
        <div class="tm_main_container tm-mission-mixed">
            <!-- LEFT COLUMN: Interactive Map -->
            <div class="tm_map_column">
                <div class="tm_map_panel">
                    <div class="tm_map_header">
                        <h3><i class="fa fa-map-marker-alt me-2"/>Bulk Location Selector</h3>
                        <div class="tm_map_controls">
                            <button type="button" class="btn btn-sm btn-outline-info ms-2" t-on-click="fitMapToAllMarkers">
                                <i class="fa fa-search me-1"/>Fit to View
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" t-on-click="clearAllMarkers">
                                <i class="fa fa-trash me-1"/>Clear All
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-warning ms-2" t-on-click="loadDriversAndVehicles">
                                <i class="fa fa-refresh me-1"/>Refresh Data
                            </button>
                            <button type="button" class="btn btn-sm btn-success ms-2" t-on-click="generateCompleteJSON">
                                <i class="fa fa-download me-1"/>Generate JSON
                            </button>
                            <button type="button" class="btn btn-sm btn-warning ms-2" t-on-click="addDefaultCargoToAllDestinations">
                                <i class="fa fa-box me-1"/>Add Default Cargo
                            </button>
                            <button type="button" class="btn btn-sm btn-primary ms-2" t-on-click="optimizeWithAI">
                                <i class="fa fa-robot me-1"/>ðŸ¤– AI Optimize
                            </button>
                        </div>
                    </div>
                    
                    <!-- The Map Container -->
                    <div class="tm_interactive_map" t-ref="mapContainer">
                        <!-- Leaflet map will be rendered here by JS -->
                    </div>
                    
                    <!-- Map Instructions -->
                    <div class="tm_map_instructions">
                        <div class="tm_instruction_item">
                            <i class="fa fa-mouse-pointer text-primary"/>
                            <span>Click on map to add sources</span>
                        </div>
                        <div class="tm_instruction_item">
                            <i class="fa fa-plus-circle text-success"/>
                            <span>Right-click to add destinations</span>
                        </div>
                        <div class="tm_instruction_item">
                            <i class="fa fa-arrows-alt text-warning"/>
                            <span>Drag markers to adjust positions</span>
                        </div>
                        <div class="tm_instruction_item">
                            <i class="fa fa-download text-info"/>
                            <span>Click "Generate JSON" to log all data</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: Location Details -->
            <div class="tm_details_column">
                <!-- Header -->
                <div class="tm_mission_header">
                    <div class="tm_title_section">
                        <h1>Bulk Location Selection</h1>
                        <div class="tm_mission_type_badge">
                            <span class="badge badge-primary tm_mixed_badge">
                                <i class="fa fa-map-marker me-1"/>
                                Selection Mode
                            </span>
                        </div>
                    </div>
                    
                    <div class="tm_metrics_grid">
                        <div class="tm_metric_card">
                            <div class="tm_metric_icon"><i class="fa fa-play-circle"/></div>
                            <div class="tm_metric_content">
                                <span class="tm_metric_label">Sources</span>
                                <div class="tm_metric_value">
                                    <span><t t-esc="state.sources.length"/></span>
                                </div>
                            </div>
                        </div>
                        <div class="tm_metric_card">
                            <div class="tm_metric_icon"><i class="fa fa-flag"/></div>
                            <div class="tm_metric_content">
                                <span class="tm_metric_label">Destinations</span>
                                <div class="tm_metric_value">
                                    <span><t t-esc="state.destinations.length"/></span>
                                </div>
                            </div>
                        </div>
                        <div class="tm_metric_card">
                            <div class="tm_metric_icon"><i class="fa fa-truck"/></div>
                            <div class="tm_metric_content">
                                <span class="tm_metric_label">Available Vehicles</span>
                                <div class="tm_metric_value">
                                    <span><t t-esc="state.vehicles.length"/></span>
                                </div>
                            </div>
                        </div>
                        <div class="tm_metric_card">
                            <div class="tm_metric_icon"><i class="fa fa-users"/></div>
                            <div class="tm_metric_content">
                                <span class="tm_metric_label">Available Drivers</span>
                                <div class="tm_metric_value">
                                    <span><t t-esc="state.drivers.length"/></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Location Details Form Sections -->
                <div class="tm_details_form">
                    <!-- Sources List Section -->
                    <div class="tm_form_section">
                        <h4><i class="fa fa-play-circle me-2 text-primary"/>Selected Sources</h4>
                        
                        <div class="tm_location_display">
                            <t t-if="state.sources.length === 0">
                                <div class="tm_empty_destinations">
                                    <i class="fa fa-map-marker-alt fa-2x text-muted mb-2"/>
                                    <p class="text-muted">No sources selected yet.</p>
                                    <p class="text-muted small">Click on the map to add sources.</p>
                                </div>
                            </t>
                            
                            <t t-foreach="state.sources" t-as="source" t-key="source.id">
                                <div class="tm_location_item tm_source_item">
                                    <div class="tm_destination_number"><t t-esc="source_index + 1"/></div>
                                    <i class="fa fa-truck text-primary"/>
                                    <div class="tm_location_info">
                                        <span class="tm_location_address"><t t-esc="source.location"/></span>
                                        <small class="tm_location_coords">
                                            <t t-esc="source.latitude.toFixed(4)"/>, <t t-esc="source.longitude.toFixed(4)"/>
                                        </small>
                                        
                                        <!-- Source Details -->
                                        <div class="tm_package_details">
                                            <div class="tm_package_row">
                                                <div class="tm_package_field">
                                                    <label>Source Name</label>
                                                    <input type="text" class="form-control form-control-sm" 
                                                           t-att-value="source.name || ''"
                                                           t-on-change="(ev) => this.updateSourceField(source_index, 'name', ev.target.value)"
                                                           placeholder="Enter source name"/>
                                                </div>
                                                <div class="tm_package_field">
                                                    <label>Source Type</label>
                                                    <select class="form-select form-select-sm" 
                                                            t-att-value="source.source_type || 'warehouse'"
                                                            t-on-change="(ev) => this.updateSourceField(source_index, 'source_type', ev.target.value)">
                                                        <option value="warehouse">Warehouse</option>
                                                        <option value="depot">Depot</option>
                                                        <option value="supplier">Supplier</option>
                                                        <option value="factory">Factory</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-danger tm_remove_dest_btn" 
                                            t-on-click="() => this.removeSource(source_index)"
                                            title="Remove source">
                                        <i class="fa fa-trash"/>
                                    </button>
                                </div>
                            </t>
                        </div>
                    </div>

                    <!-- Destinations List -->
                    <div class="tm_form_section">
                        <h4>
                            <i class="fa fa-flag-checkered me-2 text-success"/>
                            Selected Destinations 
                            <span class="badge badge-secondary"><t t-esc="state.destinations.length"/></span>
                        </h4>
                        <div class="tm_destinations_list">
                            <t t-if="state.destinations.length > 0">
                                <t t-foreach="state.destinations" t-as="dest" t-key="dest.id">
                                    <div class="tm_location_item tm_destination_item tm_clickable_destination" 
                                         t-att-class="'tm-dest-' + (dest.mission_type || 'delivery')"
                                         t-on-click="() => this.openDestinationPopup(dest_index)">
                                        <div class="tm_destination_number"><t t-esc="dest_index + 1"/></div>
                                        <div class="tm_destination_type_icon">
                                            <i t-if="dest.mission_type === 'pickup'" class="fa fa-arrow-up text-info" title="Pickup"/>
                                            <i t-else="" class="fa fa-arrow-down text-success" title="Delivery"/>
                                        </div>
                                        <div class="tm_location_info">
                                            <div class="tm_destination_header">
                                                <span class="tm_destination_name"><t t-esc="dest.name || 'Unnamed Destination'"/></span>
                                                <span class="tm_destination_type_badge badge" t-att-class="dest.mission_type === 'pickup' ? 'badge-info' : 'badge-success'">
                                                    <t t-esc="dest.mission_type || 'delivery'"/>
                                                </span>
                                            </div>
                                            <span class="tm_location_address"><t t-esc="dest.location"/></span>
                                            <div class="tm_destination_summary">
                                                <span class="tm_weight_info">
                                                    <i class="fa fa-weight-hanging"/>
                                                    <t t-esc="dest.total_weight || 0"/> kg
                                                </span>
                                                <span class="tm_volume_info">
                                                    <i class="fa fa-cube"/>
                                                    <t t-esc="dest.total_volume || 0"/> mÂ³
                                                </span>
                                                <span class="tm_package_info">
                                                    <i class="fa fa-box"/>
                                                    <t t-esc="dest.package_type || 'individual'"/>
                                                </span>
                                            </div>
                                            <small class="tm_location_coords">
                                                <t t-esc="dest.latitude.toFixed(4)"/>, <t t-esc="dest.longitude.toFixed(4)"/>
                                            </small>
                                        </div>
                                        <div class="tm_destination_actions">
                                            <button type="button" class="btn btn-sm btn-outline-primary tm_edit_dest_btn" 
                                                    t-on-click.stop="() => this.openDestinationPopup(dest_index)"
                                                    title="Edit destination details">
                                                <i class="fa fa-edit"/>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger tm_remove_dest_btn" 
                                                    t-on-click.stop="() => this.removeDestination(dest_index)"
                                                    title="Remove destination">
                                                <i class="fa fa-trash"/>
                                            </button>
                                        </div>
                                    </div>
                                </t>
                            </t>
                            <t t-else="">
                                <div class="tm_empty_destinations">
                                    <i class="fa fa-flag-checkered fa-2x text-muted mb-2"/>
                                    <p class="text-muted">No destinations selected yet.</p>
                                    <p class="text-muted small">Right-click on the map to add destinations.</p>
                                </div>
                            </t>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </t>



</templates>