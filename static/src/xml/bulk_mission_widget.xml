<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">

    <t t-name="transport_management.BulkMissionWidget" owl="1">
        <div class="tm_main_container tm-mission-mixed">
            <!-- LEFT COLUMN: Interactive Map -->
            <div class="tm_map_column">
                <div class="tm_map_panel">
                    <div class="tm_map_header">
                        <h3><i class="fa fa-map-marker-alt me-2"/>Bulk Location Selector</h3>
                        <div class="tm_map_controls">
                            <button type="button" class="btn btn-sm btn-outline-info ms-2" t-on-click="fitMapToAllMarkers">
                                <i class="fa fa-search me-1"/>Fit to View
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" t-on-click="clearAllMarkers">
                                <i class="fa fa-trash me-1"/>Clear All
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-warning ms-2" t-on-click="loadDriversAndVehicles">
                                <i class="fa fa-refresh me-1"/>Refresh Data
                            </button>
                            <button type="button" class="btn btn-sm btn-success ms-2" t-on-click="generateCompleteJSON">
                                <i class="fa fa-download me-1"/>Generate JSON
                            </button>
                            <button type="button" class="btn btn-sm btn-warning ms-2" t-on-click="addDefaultCargoToAllDestinations">
                                <i class="fa fa-box me-1"/>Add Default Cargo
                            </button>
                            <button type="button" class="btn btn-sm btn-primary ms-2" t-on-click="optimizeWithAI">
                                <i class="fa fa-robot me-1"/>ðŸ¤– AI Optimize
                            </button>
                        </div>
                    </div>
                    
                    <!-- The Map Container -->
                    <div class="tm_interactive_map" t-ref="mapContainer">
                        <!-- Leaflet map will be rendered here by JS -->
                    </div>
                    
                    <!-- Map Instructions -->
                    <div class="tm_map_instructions">
                        <div class="tm_instruction_item">
                            <i class="fa fa-mouse-pointer text-primary"/>
                            <span>Click on map to add sources</span>
                        </div>
                        <div class="tm_instruction_item">
                            <i class="fa fa-plus-circle text-success"/>
                            <span>Right-click to add destinations</span>
                        </div>
                        <div class="tm_instruction_item">
                            <i class="fa fa-arrows-alt text-warning"/>
                            <span>Drag markers to adjust positions</span>
                        </div>
                        <div class="tm_instruction_item">
                            <i class="fa fa-download text-info"/>
                            <span>Click "Generate JSON" to log all data</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: Location Details -->
            <div class="tm_details_column">
                <!-- Header -->
                <div class="tm_mission_header">
                    <div class="tm_title_section">
                        <h1>Bulk Location Selection</h1>
                        <div class="tm_mission_type_badge">
                            <span class="badge badge-primary tm_mixed_badge">
                                <i class="fa fa-map-marker me-1"/>
                                Selection Mode
                            </span>
                        </div>
                    </div>
                    
                    <div class="tm_metrics_grid">
                        <div class="tm_metric_card">
                            <div class="tm_metric_icon"><i class="fa fa-play-circle"/></div>
                            <div class="tm_metric_content">
                                <span class="tm_metric_label">Sources</span>
                                <div class="tm_metric_value">
                                    <span><t t-esc="state.sources.length"/></span>
                                </div>
                            </div>
                        </div>
                        <div class="tm_metric_card">
                            <div class="tm_metric_icon"><i class="fa fa-flag"/></div>
                            <div class="tm_metric_content">
                                <span class="tm_metric_label">Destinations</span>
                                <div class="tm_metric_value">
                                    <span><t t-esc="state.destinations.length"/></span>
                                </div>
                            </div>
                        </div>
                        <div class="tm_metric_card">
                            <div class="tm_metric_icon"><i class="fa fa-truck"/></div>
                            <div class="tm_metric_content">
                                <span class="tm_metric_label">Available Vehicles</span>
                                <div class="tm_metric_value">
                                    <span><t t-esc="state.vehicles.length"/></span>
                                </div>
                            </div>
                        </div>
                        <div class="tm_metric_card">
                            <div class="tm_metric_icon"><i class="fa fa-users"/></div>
                            <div class="tm_metric_content">
                                <span class="tm_metric_label">Available Drivers</span>
                                <div class="tm_metric_value">
                                    <span><t t-esc="state.drivers.length"/></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Missions Section -->
                <div class="tm_ai_missions_section" t-if="state.showAIMissions and state.aiMissions.length > 0">
                    <div class="tm_section_header">
                        <h4><i class="fa fa-robot me-2 text-primary"/>AI Generated Missions</h4>
                        <div class="tm_mission_controls">
                            <button type="button" class="btn btn-sm btn-outline-secondary" t-on-click="toggleMissionView">
                                <i class="fa fa-eye me-1"/>Toggle View
                            </button>
                            <button type="button" class="btn btn-sm btn-success" t-on-click="createMissionsFromAI">
                                <i class="fa fa-plus me-1"/>Create Missions
                            </button>
                        </div>
                    </div>
                    
                    <div class="tm_missions_list">
                        <t t-foreach="state.aiMissions" t-as="mission" t-key="mission_index">
                            <div class="tm_mission_item" 
                                 t-att-class="state.selectedMissionIndex === mission_index ? 'tm_mission_selected' : ''"
                                 t-on-click="() => this.selectMission(mission_index)">
                                <div class="tm_mission_header">
                                    <div class="tm_mission_number" t-att-style="'background-color: ' + this.getMissionColor(mission_index)">
                                        <t t-esc="mission_index + 1"/>
                                    </div>
                                    <div class="tm_mission_info">
                                        <h6 class="tm_mission_name"><t t-esc="mission.mission_name || 'Unnamed Mission'"/></h6>
                                        <div class="tm_mission_details">
                                            <span class="tm_mission_vehicle">
                                                <i class="fa fa-truck"/>
                                                <t t-esc="mission.assigned_vehicle?.vehicle_name || 'No Vehicle'"/>
                                            </span>
                                            <span class="tm_mission_driver">
                                                <i class="fa fa-user"/>
                                                <t t-esc="mission.assigned_driver?.driver_name || 'No Driver'"/>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tm_mission_stats">
                                    <div class="tm_stat_item">
                                        <i class="fa fa-flag"/>
                                        <span><t t-esc="mission.destinations?.length || 0"/> stops</span>
                                    </div>
                                    <div class="tm_stat_item" t-if="mission.calculated_route">
                                        <i class="fa fa-route"/>
                                        <span><t t-esc="mission.calculated_route.distance_km?.toFixed(1) || '0'"/> km</span>
                                    </div>
                                    <div class="tm_stat_item" t-if="mission.calculated_route">
                                        <i class="fa fa-clock"/>
                                        <span><t t-esc="Math.round(mission.calculated_route.duration_minutes || 0)"/> min</span>
                                    </div>
                                    <div class="tm_stat_item">
                                        <i class="fa fa-weight-hanging"/>
                                        <span><t t-esc="mission.capacity_utilization?.weight_utilization_percentage || 0"/>%</span>
                                    </div>
                                </div>
                                
                                <!-- Detailed Mission Information (same as single mission) -->
                                <div class="tm_mission_details" t-if="state.selectedMissionIndex === mission_index">
                                    
                                    <!-- Route Summary -->
                                    <div class="tm_form_section">
                                        <h6><i class="fa fa-list-ol me-2 text-info"/>Route Summary</h6>
                                        <div class="tm_route_summary">
                                            <div class="tm_route_step">
                                                <div class="tm_route_step_marker tm_route_start">
                                                    <i class="fa fa-play"/>
                                                </div>
                                                <div class="tm_route_step_content">
                                                    <strong>Start:</strong> <t t-esc="mission.source_location?.location || 'Unknown'"/>
                                                </div>
                                            </div>
                                            <t t-foreach="mission.destinations" t-as="dest" t-key="dest_index">
                                                <div class="tm_route_step">
                                                    <div class="tm_route_step_marker tm_route_destination">
                                                        <t t-esc="dest_index + 1"/>
                                                    </div>
                                                    <div class="tm_route_step_content">
                                                        <strong>Stop <t t-esc="dest_index + 1"/>:</strong> <t t-esc="dest.location"/>
                                                        <span class="tm_dest_type_badge badge ms-2" 
                                                              t-att-class="dest.mission_type === 'pickup' ? 'badge-info' : 'badge-success'">
                                                            <t t-esc="dest.mission_type"/>
                                                        </span>
                                                    </div>
                                                </div>
                                            </t>
                                        </div>
                                    </div>

                                    <!-- Cargo Progression -->
                                    <div class="tm_form_section" t-if="mission.capacity_utilization">
                                        <h6>
                                            <i class="fa fa-chart-line me-2 text-info"/>
                                            Capacity Utilization
                                        </h6>
                                        <div class="tm_capacity_progression">
                                            <div class="tm_progression_header">
                                                <div class="tm_truck_limits">
                                                    <span class="tm_limit_item">
                                                        <i class="fa fa-weight-hanging"/>
                                                        Weight: <strong><t t-esc="mission.capacity_utilization.weight_utilization_percentage || 0"/>%</strong>
                                                    </span>
                                                    <span class="tm_limit_item">
                                                        <i class="fa fa-cube"/>
                                                        Volume: <strong><t t-esc="mission.capacity_utilization.volume_utilization_percentage || 0"/>%</strong>
                                                    </span>
                                                    <span class="tm_limit_item">
                                                        <i class="fa fa-star"/>
                                                        Efficiency: <strong><t t-esc="mission.capacity_utilization.efficiency_score || 0"/>%</strong>
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="tm_cargo_details">
                                                <t t-foreach="mission.destinations" t-as="dest" t-key="dest_index">
                                                    <div class="tm_cargo_item">
                                                        <span class="tm_cargo_number"><t t-esc="dest_index + 1"/></span>
                                                        <div class="tm_cargo_info">
                                                            <span class="tm_cargo_name"><t t-esc="dest.name"/></span>
                                                            <div class="tm_cargo_stats">
                                                                <span class="tm_cargo_weight">
                                                                    <i class="fa fa-weight-hanging"/>
                                                                    <t t-esc="dest.cargo_details?.total_weight || 0"/>kg
                                                                </span>
                                                                <span class="tm_cargo_volume">
                                                                    <i class="fa fa-cube"/>
                                                                    <t t-esc="dest.cargo_details?.total_volume || 0"/>mÂ³
                                                                </span>
                                                                <span class="tm_cargo_type">
                                                                    <i class="fa fa-box"/>
                                                                    <t t-esc="dest.cargo_details?.package_type || 'individual'"/>
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </t>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Cost Breakdown -->
                                    <div class="tm_form_section tm_cost_section" t-if="mission.route_optimization">
                                        <h6><i class="fa fa-calculator me-2 text-success"/>Cost Breakdown</h6>
                                        <div class="tm_cost_breakdown_modern">
                                            <!-- Distance Cost -->
                                            <div class="tm_cost_row">
                                                <div class="tm_cost_icon">
                                                    <i class="fa fa-road"/>
                                                </div>
                                                <div class="tm_cost_label">Distance</div>
                                                <div class="tm_cost_amount">
                                                    <t t-esc="mission.calculated_route?.distance_km?.toFixed(1) || mission.route_optimization?.total_distance_km || 0"/> km
                                                </div>
                                            </div>
                                            
                                            <!-- Duration -->
                                            <div class="tm_cost_row">
                                                <div class="tm_cost_icon">
                                                    <i class="fa fa-clock"/>
                                                </div>
                                                <div class="tm_cost_label">Duration</div>
                                                <div class="tm_cost_amount">
                                                    <t t-esc="Math.round(mission.calculated_route?.duration_minutes || mission.route_optimization?.estimated_duration_hours * 60 || 0)"/> min
                                                </div>
                                            </div>
                                            
                                            <!-- Fuel Cost -->
                                            <div class="tm_cost_row" t-if="mission.route_optimization?.estimated_fuel_cost">
                                                <div class="tm_cost_icon">
                                                    <i class="fa fa-gas-pump"/>
                                                </div>
                                                <div class="tm_cost_label">Fuel Cost</div>
                                                <div class="tm_cost_amount">
                                                    <t t-esc="mission.route_optimization.estimated_fuel_cost.toFixed(2)"/> DH
                                                </div>
                                            </div>

                                            <!-- Driver Cost -->
                                            <div class="tm_cost_row" t-if="mission.route_optimization?.cost_breakdown?.driver_cost">
                                                <div class="tm_cost_icon">
                                                    <i class="fa fa-id-card"/>
                                                </div>
                                                <div class="tm_cost_label">Driver</div>
                                                <div class="tm_cost_amount">
                                                    <t t-esc="mission.route_optimization.cost_breakdown.driver_cost.toFixed(2)"/> DH
                                                </div>
                                            </div>

        									<!-- Maintenance Cost -->
                                            <div class="tm_cost_row" t-if="mission.route_optimization?.cost_breakdown?.maintenance_cost">
                                                <div class="tm_cost_icon">
                                                    <i class="fa fa-wrench"/>
                                                </div>
                                                <div class="tm_cost_label">Maintenance</div>
                                                <div class="tm_cost_amount">
                                                    <t t-esc="mission.route_optimization.cost_breakdown.maintenance_cost.toFixed(2)"/> DH
                                                </div>
                                            </div>

                                            <!-- Toll Cost -->
                                            <div class="tm_cost_row" t-if="mission.route_optimization?.cost_breakdown?.toll_cost">
                                                <div class="tm_cost_icon">
                                                    <i class="fa fa-road"/>
                                                </div>
                                                <div class="tm_cost_label">Tolls</div>
                                                <div class="tm_cost_amount">
                                                    <t t-esc="mission.route_optimization.cost_breakdown.toll_cost.toFixed(2)"/> DH
                                                </div>
                                            </div>

                                            <!-- Base Cost -->
                                            <div class="tm_cost_row" t-if="mission.route_optimization?.cost_breakdown?.base_cost">
                                                <div class="tm_cost_icon">
                                                    <i class="fa fa-coins"/>
                                                </div>
                                                <div class="tm_cost_label">Base</div>
                                                <div class="tm_cost_amount">
                                                    <t t-esc="mission.route_optimization.cost_breakdown.base_cost.toFixed(2)"/> DH
                                                </div>
                                            </div>

                                            <!-- Fuel Used Liters -->
                                            <div class="tm_cost_row" t-if="mission.route_optimization?.cost_breakdown?.fuel_used_liters">
                                                <div class="tm_cost_icon">
                                                    <i class="fa fa-tachometer-alt"/>
                                                </div>
                                                <div class="tm_cost_label">Fuel Used</div>
                                                <div class="tm_cost_amount">
                                                    <t t-esc="mission.route_optimization.cost_breakdown.fuel_used_liters.toFixed(2)"/> L
                                                </div>
                                            </div>
                                            
                                            <!-- Total Cost -->
                                            <div class="tm_cost_row tm_cost_total_row" t-if="mission.route_optimization?.estimated_total_cost">
                                                <div class="tm_cost_icon">
                                                    <i class="fa fa-calculator"/>
                                                </div>
                                                <div class="tm_cost_label">Total Cost</div>
                                                <div class="tm_cost_amount tm_total_amount">
                                                    <t t-esc="mission.route_optimization.estimated_total_cost.toFixed(2)"/> DH
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Mission Actions -->
                                    <div class="tm_mission_actions">
                                        <button type="button" class="btn btn-sm btn-primary" t-on-click="() => this.fitMapToMission(mission_index)">
                                            <i class="fa fa-search me-1"/>Fit to View
                                        </button>
                                        <button type="button" class="btn btn-sm btn-success" t-on-click="() => this.createSingleMissionFromAI(mission_index)">
                                            <i class="fa fa-save me-1"/>Save This Mission
                                        </button>
                                    </div>

                                    <!-- AI Explanation Section -->
                                    <div class="tm_form_section" t-if="mission._explanation">
                                        <h6><i class="fa fa-lightbulb me-2 text-warning"/>Why this plan</h6>
                                        <ul class="tm_reason_list">
                                            <t t-foreach="mission._explanation.bullets" t-as="reason" t-key="reason_index">
                                                <li class="tm_reason_item">
                                                    <i class="fa fa-check-circle text-muted me-1"/>
                                                    <t t-esc="reason"/>
                                                </li>
                                            </t>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </div>
                </div>

                <!-- Location Details Form Sections -->
                <div class="tm_details_form" t-att-class="state.showAIMissions ? 'tm_details_collapsed' : ''">
                    <!-- Sources List Section -->
                    <div class="tm_form_section">
                        <h4><i class="fa fa-play-circle me-2 text-primary"/>Selected Sources</h4>
                        
                        <div class="tm_location_display">
                            <t t-if="state.sources.length === 0">
                                <div class="tm_empty_destinations">
                                    <i class="fa fa-map-marker-alt fa-2x text-muted mb-2"/>
                                    <p class="text-muted">No sources selected yet.</p>
                                    <p class="text-muted small">Click on the map to add sources.</p>
                                </div>
                            </t>
                            
                            <t t-foreach="state.sources" t-as="source" t-key="source.id">
                                <div class="tm_location_item tm_source_item">
                                    <div class="tm_destination_number"><t t-esc="source_index + 1"/></div>
                                    <i class="fa fa-truck text-primary"/>
                                    <div class="tm_location_info">
                                        <span class="tm_location_address"><t t-esc="source.location"/></span>
                                        <small class="tm_location_coords">
                                            <t t-esc="source.latitude.toFixed(4)"/>, <t t-esc="source.longitude.toFixed(4)"/>
                                        </small>
                                        
                                        <!-- Source Details -->
                                        <div class="tm_package_details">
                                            <div class="tm_package_row">
                                                <div class="tm_package_field">
                                                    <label>Source Name</label>
                                                    <input type="text" class="form-control form-control-sm" 
                                                           t-att-value="source.name || ''"
                                                           t-on-change="(ev) => this.updateSourceField(source_index, 'name', ev.target.value)"
                                                           placeholder="Enter source name"/>
                                                </div>
                                                <div class="tm_package_field">
                                                    <label>Source Type</label>
                                                    <select class="form-select form-select-sm" 
                                                            t-att-value="source.source_type || 'warehouse'"
                                                            t-on-change="(ev) => this.updateSourceField(source_index, 'source_type', ev.target.value)">
                                                        <option value="warehouse">Warehouse</option>
                                                        <option value="depot">Depot</option>
                                                        <option value="supplier">Supplier</option>
                                                        <option value="factory">Factory</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-danger tm_remove_dest_btn" 
                                            t-on-click="() => this.removeSource(source_index)"
                                            title="Remove source">
                                        <i class="fa fa-trash"/>
                                    </button>
                                </div>
                            </t>
                        </div>
                    </div>

                    <!-- Destinations List -->
                    <div class="tm_form_section">
                        <h4>
                            <i class="fa fa-flag-checkered me-2 text-success"/>
                            Selected Destinations 
                            <span class="badge badge-secondary"><t t-esc="state.destinations.length"/></span>
                        </h4>
                        <div class="tm_destinations_list">
                            <t t-if="state.destinations.length > 0">
                                <t t-foreach="state.destinations" t-as="dest" t-key="dest.id">
                                    <div class="tm_location_item tm_destination_item tm_clickable_destination" 
                                         t-att-class="'tm-dest-' + (dest.mission_type || 'delivery')"
                                         t-on-click="() => this.openDestinationPopup(dest_index)">
                                        <div class="tm_destination_number"><t t-esc="dest_index + 1"/></div>
                                        <div class="tm_destination_type_icon">
                                            <i t-if="dest.mission_type === 'pickup'" class="fa fa-arrow-up text-info" title="Pickup"/>
                                            <i t-else="" class="fa fa-arrow-down text-success" title="Delivery"/>
                                        </div>
                                        <div class="tm_location_info">
                                            <div class="tm_destination_header">
                                                <span class="tm_destination_name"><t t-esc="dest.name || 'Unnamed Destination'"/></span>
                                                <span class="tm_destination_type_badge badge" t-att-class="dest.mission_type === 'pickup' ? 'badge-info' : 'badge-success'">
                                                    <t t-esc="dest.mission_type || 'delivery'"/>
                                                </span>
                                            </div>
                                            <span class="tm_location_address"><t t-esc="dest.location"/></span>
                                            <div class="tm_destination_summary">
                                                <span class="tm_weight_info">
                                                    <i class="fa fa-weight-hanging"/>
                                                    <t t-esc="dest.total_weight || 0"/> kg
                                                </span>
                                                <span class="tm_volume_info">
                                                    <i class="fa fa-cube"/>
                                                    <t t-esc="dest.total_volume || 0"/> mÂ³
                                                </span>
                                                <span class="tm_package_info">
                                                    <i class="fa fa-box"/>
                                                    <t t-esc="dest.package_type || 'individual'"/>
                                                </span>
                                            </div>
                                            <small class="tm_location_coords">
                                                <t t-esc="dest.latitude.toFixed(4)"/>, <t t-esc="dest.longitude.toFixed(4)"/>
                                            </small>
                                        </div>
                                        <div class="tm_destination_actions">
                                            <button type="button" class="btn btn-sm btn-outline-primary tm_edit_dest_btn" 
                                                    t-on-click.stop="() => this.openDestinationPopup(dest_index)"
                                                    title="Edit destination details">
                                                <i class="fa fa-edit"/>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger tm_remove_dest_btn" 
                                                    t-on-click.stop="() => this.removeDestination(dest_index)"
                                                    title="Remove destination">
                                                <i class="fa fa-trash"/>
                                            </button>
                                        </div>
                                    </div>
                                </t>
                            </t>
                            <t t-else="">
                                <div class="tm_empty_destinations">
                                    <i class="fa fa-flag-checkered fa-2x text-muted mb-2"/>
                                    <p class="text-muted">No destinations selected yet.</p>
                                    <p class="text-muted small">Right-click on the map to add destinations.</p>
                                </div>
                            </t>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </t>



</templates>