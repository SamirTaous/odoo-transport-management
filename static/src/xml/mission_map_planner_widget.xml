<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">

    <t t-name="transport_management.MissionMapPlannerWidget" owl="1">
        <div class="tm_main_container" t-att-class="'tm-mission-' + (props.record.data.mission_type || 'delivery')">
            <!-- LEFT COLUMN: Interactive Map -->
            <div class="tm_map_column">
                <div class="tm_map_panel">
                    <div class="tm_map_header">
                        <h3><i class="fa fa-map-marker-alt me-2"/>Mission Route Planner</h3>
                        <div class="tm_map_controls">
                            <button type="button" class="btn btn-sm btn-outline-primary" t-on-click="clearAllMarkers">
                                <i class="fa fa-trash me-1"/>Clear All
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info ms-2" t-on-click="fitMapToMarkers">
                                <i class="fa fa-search me-1"/>Fit to View
                            </button>
                        </div>
                    </div>
                    
                    <!-- Mission Status and Optimization Panel -->
                    <div class="tm_map_status_panel">
                        <div class="tm_status_section">
                            <div class="tm_status_header">
                                <h5><i class="fa fa-tasks me-2"/>Mission Status</h5>
                            </div>
                            <div class="tm_status_controls">
                                <div class="tm_status_buttons">
                                    <!-- Draft Status - Always visible, shows current state -->
                                    <div class="tm_status_indicator tm_status_draft" 
                                         t-att-class="{'active': props.record.data.state === 'draft'}">
                                        <span>Draft</span>
                                    </div>
                                    
                                    <!-- Confirm Button - Only show if in draft state -->
                                    <button type="button" 
                                            t-if="props.record.data.state === 'draft'"
                                            class="tm_status_btn tm_status_confirmed" 
                                            t-on-click="() => this.updateMissionState('confirmed')">
                                        <i class="fa fa-check me-1"/>
                                        <span>Confirm</span>
                                    </button>
                                    
                                    <!-- Confirmed Status Indicator -->
                                    <div t-if="props.record.data.state !== 'draft'"
                                         class="tm_status_indicator tm_status_confirmed" 
                                         t-att-class="{'active': props.record.data.state === 'confirmed'}">
                                        <i class="fa fa-check me-1"/>
                                        <span>Confirmed</span>
                                    </div>
                                    
                                    <!-- Start Button - Only show if confirmed -->
                                    <button type="button" 
                                            t-if="props.record.data.state === 'confirmed'"
                                            class="tm_status_btn tm_status_progress" 
                                            t-on-click="() => this.updateMissionState('in_progress')">
                                        <i class="fa fa-play me-1"/>
                                        <span>Start</span>
                                    </button>
                                    
                                    <!-- In Progress Status Indicator -->
                                    <div t-if="props.record.data.state === 'in_progress' || props.record.data.state === 'done' || props.record.data.state === 'cancelled'"
                                         class="tm_status_indicator tm_status_progress" 
                                         t-att-class="{'active': props.record.data.state === 'in_progress'}">
                                        <i class="fa fa-play me-1"/>
                                        <span>In Progress</span>
                                    </div>
                                    
                                    <!-- Complete Button - Only show if in progress -->
                                    <button type="button" 
                                            t-if="props.record.data.state === 'in_progress'"
                                            class="tm_status_btn tm_status_done" 
                                            t-on-click="() => this.updateMissionState('done')">
                                        <i class="fa fa-flag-checkered me-1"/>
                                        <span>Complete</span>
                                    </button>
                                    
                                    <!-- Done Status Indicator -->
                                    <div t-if="props.record.data.state === 'done'"
                                         class="tm_status_indicator tm_status_done active">
                                        <i class="fa fa-flag-checkered me-1"/>
                                        <span>Done</span>
                                    </div>
                                    
                                    <!-- Cancel Button - Show if not done -->
                                    <button type="button" 
                                            t-if="props.record.data.state != 'done' and props.record.data.state != 'cancelled'"
                                            class="tm_status_btn tm_status_cancel" 
                                            t-on-click="() => this.updateMissionState('cancelled')">
                                        <i class="fa fa-times me-1"/>
                                        <span>Cancel</span>
                                    </button>
                                    
                                    <!-- Cancelled Status Indicator -->
                                    <div t-if="props.record.data.state === 'cancelled'"
                                         class="tm_status_indicator tm_status_cancelled active">
                                        <i class="fa fa-times me-1"/>
                                        <span>Cancelled</span>
                                    </div>
                                </div>
                                <div class="tm_optimization_controls">
                                    <button type="button" class="btn btn-sm btn-success tm_optimize_btn" t-on-click="optimizeRoute">
                                        <i class="fa fa-route me-1"/>Optimize Route
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- The Map Container -->
                    <div class="tm_interactive_map" t-ref="mapContainer">
                        <!-- Leaflet map will be rendered here by JS -->
                    </div>
                    
                    <!-- Map Instructions -->
                    <div class="tm_map_instructions">
                        <div class="tm_instruction_item">
                            <i class="fa fa-mouse-pointer text-primary"/>
                            <span>Click on map to set source</span>
                        </div>
                        <div class="tm_instruction_item">
                            <i class="fa fa-plus-circle text-success"/>
                            <span>Right-click to add destinations</span>
                        </div>
                        <div class="tm_instruction_item">
                            <i class="fa fa-arrows-alt text-warning"/>
                            <span>Drag markers to adjust positions</span>
                        </div>
                        <div class="tm_instruction_item">
                            <i class="fa fa-trash text-danger"/>
                            <span>Click markers to delete destinations</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: Mission Details -->
            <div class="tm_details_column">
                <!-- Mission Header -->
                <div class="tm_mission_header">
                    <div class="tm_title_section">
                        <h1><t t-esc="props.record.data.name or 'New Mission'"/></h1>
                        <div class="tm_mission_type_badge">
                            <span t-if="props.record.data.mission_type === 'pickup'" class="badge badge-info tm_pickup_badge">
                                <i class="fa fa-arrow-up me-1"/>Pickup Mission
                            </span>
                            <span t-elif="props.record.data.mission_type === 'delivery'" class="badge badge-success tm_delivery_badge">
                                <i class="fa fa-arrow-down me-1"/>Delivery Mission
                            </span>
                        </div>
                    </div>
                    
                    <div class="tm_metrics_grid">
                        <div class="tm_metric_card">
                            <div class="tm_metric_icon"><i class="fa fa-route"/></div>
                            <div class="tm_metric_content">
                                <span class="tm_metric_label">Total Distance</span>
                                <div class="tm_metric_value">
                                    <span><t t-esc="state.totalDistance.toFixed(2)"/> km</span>
                                </div>
                            </div>
                        </div>
                        <div class="tm_metric_card">
                             <div class="tm_metric_icon"><i class="fa fa-tasks"/></div>
                             <div class="tm_metric_content">
                                <span class="tm_metric_label">Progress</span>
                                <div class="progress" style="height: 20px;">
                                   <div class="progress-bar" role="progressbar" t-attf-style="width: {{props.record.data.destination_progress || 0}}%;" t-att-aria-valuenow="props.record.data.destination_progress || 0" aria-valuemin="0" aria-valuemax="100">
                                       <t t-esc="(props.record.data.destination_progress || 0).toFixed(0)"/>%
                                   </div>
                               </div>
                             </div>
                        </div>
                    </div>
                </div>

                <!-- Mission Details Form Sections -->
                <div class="tm_details_form">
                    <!-- Mission Configuration Section -->
                    <div class="tm_form_section">
                        <h4><i class="fa fa-cog me-2 text-info"/>Mission Configuration</h4>
                        <div class="tm_config_grid">
                            <div class="tm_config_item">
                                <label class="tm_config_label">Mission Type</label>
                                <div class="tm_config_value">
                                    <div class="tm_radio_group">
                                        <label class="tm_radio_option">
                                            <input type="radio" name="mission_type" value="pickup" 
                                                   t-att-checked="props.record.data.mission_type === 'pickup'"
                                                   t-on-change="onMissionTypeChange"/>
                                            <span class="tm_radio_label">
                                                <i class="fa fa-arrow-up me-1"/>Pickup
                                            </span>
                                        </label>
                                        <label class="tm_radio_option">
                                            <input type="radio" name="mission_type" value="delivery" 
                                                   t-att-checked="props.record.data.mission_type === 'delivery'"
                                                   t-on-change="onMissionTypeChange"/>
                                            <span class="tm_radio_label">
                                                <i class="fa fa-arrow-down me-1"/>Delivery
                                            </span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tm_config_item">
                                <label class="tm_config_label">Mission Date</label>
                                <div class="tm_config_value">
                                    <input type="date" class="form-control" 
                                           t-att-value="props.record.data.mission_date"
                                           t-on-change="onMissionDateChange"/>
                                </div>
                            </div>
                            
                            <div class="tm_config_item">
                                <label class="tm_config_label">Driver</label>
                                <div class="tm_config_value">
                                    <div class="tm_driver_display">
                                        <t t-if="props.record.data.driver_id">
                                            <div class="tm_driver_avatar">
                                                <i class="fa fa-user"/>
                                            </div>
                                            <span><t t-esc="props.record.data.driver_id[1] || 'Select Driver'"/></span>
                                        </t>
                                        <t t-else="">
                                            <span class="text-muted">Select Driver</span>
                                        </t>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tm_config_item">
                                <label class="tm_config_label">Vehicle</label>
                                <div class="tm_config_value">
                                    <div class="tm_vehicle_display">
                                        <i class="fa fa-truck me-2"/>
                                        <span><t t-esc="props.record.data.vehicle_id and props.record.data.vehicle_id[1] or 'Select Vehicle'"/></span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tm_config_item">
                                <label class="tm_config_label">Priority</label>
                                <div class="tm_config_value">
                                    <div class="tm_priority_group">
                                        <label class="tm_priority_option tm_priority_low" t-att-class="{'active': props.record.data.priority === '0'}">
                                            <input type="radio" name="priority" value="0" 
                                                   t-att-checked="props.record.data.priority === '0'"
                                                   t-on-change="onPriorityChange"/>
                                            <span>Low</span>
                                        </label>
                                        <label class="tm_priority_option tm_priority_normal" t-att-class="{'active': props.record.data.priority === '1'}">
                                            <input type="radio" name="priority" value="1" 
                                                   t-att-checked="props.record.data.priority === '1' || !props.record.data.priority"
                                                   t-on-change="onPriorityChange"/>
                                            <span>Normal</span>
                                        </label>
                                        <label class="tm_priority_option tm_priority_high" t-att-class="{'active': props.record.data.priority === '2'}">
                                            <input type="radio" name="priority" value="2" 
                                                   t-att-checked="props.record.data.priority === '2'"
                                                   t-on-change="onPriorityChange"/>
                                            <span>High</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Source Location Display -->
                    <div class="tm_form_section">
                        <h4><i class="fa fa-play-circle me-2 text-primary"/>Source Location</h4>
                        <div class="tm_location_display">
                            <div t-if="state.source" class="tm_location_item tm_source_item">
                                <i class="fa fa-map-marker-alt text-primary"/>
                                <div class="tm_location_info">
                                    <span class="tm_location_address"><t t-esc="state.source.location"/></span>
                                    <small class="tm_location_coords"><t t-esc="state.source.latitude.toFixed(4)"/>, <t t-esc="state.source.longitude.toFixed(4)"/></small>
                                </div>
                            </div>
                            <div t-else="" class="tm_empty_destinations">
                                <p>Click on the map to set a source.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Destinations List -->
                    <div class="tm_form_section">
                        <h4>
                            <i class="fa fa-flag-checkered me-2 text-success"/>
                            Destinations 
                            <span class="badge badge-secondary"><t t-esc="state.destinations.length"/></span>
                        </h4>
                        <div class="tm_destinations_list">
                            <t t-if="state.destinations.length > 0">
                                <t t-foreach="state.destinations" t-as="dest" t-key="dest.localId">
                                    <div class="tm_location_item tm_destination_item">
                                        <div class="tm_destination_number"><t t-esc="dest.sequence"/></div>
                                        <div class="tm_location_info">
                                            <span class="tm_location_address"><t t-esc="dest.location"/></span>
                                            <small class="tm_location_coords"><t t-esc="dest.latitude.toFixed(4)"/>, <t t-esc="dest.longitude.toFixed(4)"/></small>
                                        </div>
                                        <div class="tm_location_actions">
                                            <button type="button" class="btn btn-sm btn-outline-danger" t-on-click="() => this.removeDestinationByLocalId(dest.localId)">
                                                <i class="fa fa-trash"/>
                                            </button>
                                        </div>
                                    </div>
                                </t>
                            </t>
                            <div t-else="" class="tm_empty_destinations">
                                <i class="fa fa-map-signs fa-2x text-muted"/>
                                <p>Right-click on map to add destinations</p>
                            </div>
                        </div>
                    </div>

                    <!-- Operational Notes Section -->
                    <div class="tm_form_section">
                        <h4><i class="fa fa-sticky-note me-2 text-warning"/>Operational Notes</h4>
                        <div class="tm_notes_container">
                            <textarea class="form-control tm_notes_textarea" 
                                      placeholder="Add mission notes and special instructions..."
                                      t-att-value="props.record.data.notes"
                                      t-on-change="onNotesChange"
                                      rows="4"></textarea>
                        </div>
                    </div>

                    <!-- Route Summary -->
                    <div class="tm_form_section" t-if="state.source and state.destinations.length > 0">
                        <h4><i class="fa fa-list-ol me-2 text-info"/>Route Summary</h4>
                        <div class="tm_route_summary">
                            <div class="tm_route_step">
                                <div class="tm_route_step_marker tm_route_start">
                                    <i class="fa fa-play"/>
                                </div>
                                <div class="tm_route_step_content">
                                    <strong>Start:</strong> <t t-esc="state.source.location"/>
                                </div>
                            </div>
                            <t t-foreach="state.destinations" t-as="dest" t-key="dest.localId">
                                <div class="tm_route_step">
                                    <div class="tm_route_step_marker tm_route_destination">
                                        <t t-esc="dest.sequence"/>
                                    </div>
                                    <div class="tm_route_step_content">
                                        <strong>Stop <t t-esc="dest.sequence"/>:</strong> <t t-esc="dest.location"/>
                                    </div>
                                </div>
                            </t>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </t>

</templates>